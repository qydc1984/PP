# Hypervisor 测试客户端使用文档

## 目录
1. 概述
2. 系统要求
3. 安装和部署
4. 快速开始
5. 命令行参数
6. 测试功能详解
7. 测试报告
8. 故障排除
9. 常见问题
10. 技术支持

## 1. 概述

Hypervisor 测试客户端是一个专门用于测试和验证 memhv (AMD SVM) 和 airhv (Intel VT-x) hypervisor 驱动的工具。它提供了完整的功能测试、性能基准测试和诊断功能，帮助开发者快速定位和解决驱动问题。

主要特性：
- 支持 memhv 和 airhv 双驱动测试
- 模块化测试设计，可单独测试特定功能
- 详细的测试报告生成
- 性能基准测试
- 错误诊断和故障排除
- 跨平台支持 (x64 和 ARM64)

## 2. 系统要求

硬件要求：
- AMD 系统: 支持 AMD-V (SVM) 技术的处理器
- Intel 系统: 支持 Intel VT-x 技术的处理器
- 至少 4GB RAM
- 至少 100MB 可用磁盘空间

软件要求：
- Windows 10/11 或 Windows Server 2019/2022
- 管理员权限
- 已正确安装对应的 hypervisor 驱动

支持的平台：
- Windows x64
- Windows ARM64

## 3. 安装和部署

部署文件结构：
Deployment/
├── memhv.sys          # AMD SVM 驱动 (AMD 系统)
├── airhv.sys          # Intel VT-x 驱动 (Intel 系统)
└── test_client.exe    # 测试客户端应用程序

部署步骤：

1. 确定系统类型
   # 检查处理器类型
   test_client.exe --help

2. AMD 系统部署
   # 复制文件
   copy memhv.sys C:\Windows\System32\drivers\
   copy test_client.exe C:\Tools\

3. Intel 系统部署
   # 复制文件
   copy airhv.sys C:\Windows\System32\drivers\
   copy test_client.exe C:\Tools\

4. 验证部署
   cd C:\Tools\
   test_client.exe --help

## 4. 快速开始

基本测试：
# 自动检测并测试 (推荐)
test_client.exe --auto

# 或者不带参数运行 (默认自动检测)
test_client.exe

指定驱动测试：
# 仅测试 memhv 驱动
test_client.exe --memhv

# 仅测试 airhv 驱动
test_client.exe --airhv

完整测试：
# 测试两个驱动
test_client.exe --both

## 5. 命令行参数

主要参数：
--memhv     : 仅测试 memhv 驱动 (AMD SVM)
--airhv     : 仅测试 airhv 驱动 (Intel VT-x)
--both      : 依次测试两个驱动
--auto      : 自动检测并测试 (默认)
--help      : 显示帮助信息

返回值：
0   : 所有测试通过
-1  : 测试失败或发生错误
其他: 内部错误代码

## 6. 测试功能详解

1. 驱动存在性检测
   验证指定的 hypervisor 驱动是否正确加载和运行。

2. 初始化测试
   检查驱动的初始化过程是否正常完成。

3. 处理器数量检测
   验证驱动是否能正确检测系统中的处理器数量。

4. 进程访问测试
   测试驱动访问系统进程（如 System 进程）的能力。

5. 进程目录基址获取
   验证驱动获取进程页目录基址（CR3）的功能。

6. 内存读取测试
   测试驱动读取进程内存的能力。

7. 内存写入测试
   测试驱动写入进程内存的能力（安全模式下跳过）。

8. 进程枚举测试
   验证驱动遍历系统进程链表的功能。

9. 自我保护测试
   测试驱动的自我保护功能。

10. MSR 验证测试
    验证驱动对 MSR 寄存器地址的验证能力。

11. 用户地址验证测试
    测试驱动对用户态地址有效性的验证。

12. 对象管理测试
    验证驱动的对象引用计数管理功能。

13. 安全内存操作测试
    测试驱动的安全内存读写功能。

14. 高级功能测试 (airhv)
    测试 airhv 特有的高级功能，如 MSR 拦截、IO 拦截等。

## 7. 测试报告

报告内容：
测试完成后会显示详细的测试报告，包括：

1. 测试摘要
   - 总测试数
   - 通过数
   - 失败数
   - 跳过数

2. 详细结果
   - 每个测试项的状态
   - 执行时间
   - 错误信息（如果有）

3. 性能指标
   - 读取速度
   - 写入速度
   - 拷贝速度

报告示例：
============================================================
memhv (AMD SVM) 驱动测试
============================================================

[*] 测试1: 驱动存在性检测
[+] 驱动存在性: 通过 - memhv驱动已加载并运行

[*] 测试2: 初始化检测
[+] 初始化: 通过 - 驱动已正确初始化

[*] 测试3: 处理器数量
[+] 处理器数量: 通过 - 检测到 8 个处理器

[*] 测试4: 进程访问
[+] 进程访问: 通过 - 成功获取System进程对象

----------------------------------------
memhv 测试摘要
总测试数: 15
通过: 13
失败: 0
跳过: 2
----------------------------------------

## 8. 故障排除

常见问题及解决方案：

1. "驱动未检测到" 错误
   问题: 测试显示驱动未加载
   解决方案:
   # 检查驱动是否已安装
   sc query memhv
   sc query airhv

   # 手动加载驱动
   sc start memhv
   # 或
   sc start airhv

2. "无法获取 System 进程" 错误
   问题: 无法访问 System 进程
   解决方案:
   - 确保以管理员权限运行
   - 检查驱动权限设置
   - 重启系统后重试

3. "内存读取失败" 错误
   问题: 无法读取指定内存地址
   解决方案:
   - 检查地址有效性
   - 验证进程权限
   - 确认驱动保护机制

4. "处理器检测失败" 错误
   问题: 无法获取处理器信息
   解决方案:
   - 检查硬件虚拟化是否启用
   - 确认 BIOS/UEFI 设置
   - 验证驱动兼容性

调试技巧：

启用详细日志：
# 在命令提示符中设置环境变量
set VERBOSE=1
test_client.exe --auto

使用事件查看器：
# 查看系统日志中的驱动相关事件
eventvwr.msc

内存转储分析：
# 生成内存转储用于分析
# (需要配置相应的调试环境)

## 9. 常见问题

Q1: 如何确定我的系统应该使用哪个驱动？
A: 使用 CPU-Z 或系统信息工具检查处理器类型：
   - AMD 处理器使用 memhv
   - Intel 处理器使用 airhv

Q2: 测试显示所有项目都跳过了怎么办？
A: 这通常表示驱动未正确加载。请检查：
   1. 驱动是否已正确安装
   2. 是否以管理员权限运行
   3. 硬件虚拟化是否在 BIOS 中启用

Q3: 可以在虚拟机中运行测试吗？
A: 可以，但需要确保：
   1. 虚拟机软件支持嵌套虚拟化
   2. 已在虚拟机设置中启用硬件虚拟化
   3. 性能可能会受到影响

Q4: 测试会影响系统稳定性吗？
A: 测试客户端设计为安全模式，不会：
   - 修改系统关键文件
   - 强制终止系统进程
   - 进行危险的内存写入操作

   但建议在测试前：
   - 保存所有重要工作
   - 关闭关键应用程序
   - 在测试环境中进行

Q5: 如何解释测试结果？
A: 测试结果含义：
   - 通过: 功能正常工作
   - 失败: 功能存在错误，需要检查
   - 跳过: 条件不满足或为安全考虑跳过

## 10. 技术支持

获取帮助：
如果遇到问题，请提供以下信息：
1. 完整的测试输出
2. 系统规格（处理器型号、内存大小等）
3. Windows 版本信息
4. 驱动版本号
5. 错误发生时的具体操作步骤

联系方式：
- 项目主页: [您的项目地址]
- 问题跟踪: [您的问题跟踪系统]
- 邮件支持: [您的支持邮箱]

社区支持：
- 论坛: [您的社区论坛]
- 文档: [您的在线文档]
- 示例: [您的示例代码库]

注意: 本工具仅供开发和测试使用，请勿在生产环境中使用。使用本工具造成的任何损失，开发者不承担任何责任。

版本: 1.0
最后更新: 2024
许可证: [您的许可证信息]